<!--
Sync Impact Report
Version: 1.3.0 → 1.4.0
Modified Principles:
- Workflow & Quality Gates (INVEST user story and incremental delivery requirements)
Added Sections:
- None
Removed Sections:
- None
Templates:
- .specify/templates/plan-template.md ✅ updated
- .specify/templates/spec-template.md ✅ updated
- .specify/templates/tasks-template.md ✅ updated
Follow-ups:
- None
-->

# Smart Letter Constitution

## Core Principles

### I. Contract-First Interfaces
- Publish OpenAPI definitions and example payloads under `docs/contracts/openapi.yaml` before implementing any controller or client.
- Enforce `jakarta.validation` and explicit error contracts on every DTO so invalid data is rejected deterministically and logged with correlation IDs.
- Introduce new response fields in a backward compatible way; breaking changes require versioned routes or header-based negotiation plus a documented migration window.
*Rationale*: Stable contracts keep downstream systems predictable and minimize regression risk in this single-purpose microservice.

### II. LLM Safety Envelope
- Route all prompt/response traffic through a single Spring `WebClient` that applies strict timeouts, retry/backoff rules, request/response size caps, and prompt redaction for secrets or PII before the payload leaves the service boundary.
- Persist hashed prompt metadata and model decisions in audit logs so production issues can be replayed without exposing user data.
- Provide deterministic fallbacks: if the LLM call fails or violates policy, return a templated human-authored email body and flag the incident via metrics/alerts instead of delivering unreviewed content.
*Rationale*: Guardrails keep AI output safe, support compliance, and avoid user-facing failures from an upstream dependency we do not control.

### III. Rich Email Integrity
- Generate all outbound emails through vetted templates (Thymeleaf or equivalent) that emit both HTML and plaintext parts; never concatenate raw strings from model output directly into SMTP payloads.
- Enforce accessibility (semantic headings, meaningful alt text) and sanitize the final markup before sending; snapshot tests must detect unintended markup changes.
- Validate deliverability by linting links, inline CSS, and required footer content; block deployment if rendering tests fail.
*Rationale*: The email is the only user-visible surface, so high-fidelity rendering and safety gates are mandatory.

## Service Guardrails

- **Runtime Stack**: Java 21, Spring Boot 3.3.x, Gradle build, Spring MVC controllers, Spring WebClient for outbound HTTP, and Spring Mail/Jakarta Mail for SMTP. Deviations require architecture approval.
- **LLM Integration**: Use HTTPS JSON APIs with API-key auth stored in the secrets manager; prompts live in `src/main/resources/prompts/` and must be versioned.
- **Email Delivery**: Store templates in `src/main/resources/templates/` with paired HTML/text variants, and send via a provider that supports rich text (e.g., SES, Postmark). Capture provider message IDs for traceability.
- **Configuration & Secrets**: Manage via Spring Config + environment variables; never persist raw LLM responses beyond transient processing logs.
- **Observability**: Emit Micrometer metrics (`llm.latency`, `email.sent`, `email.fallback_triggered`) and structured logs with trace IDs propagated through LLM and SMTP calls. Alerts fire when fallback rates exceed 1% per hour.
- **Containerization & Artifacts**: Every build must produce a reproducible OCI image using Paketo Buildpacks or Jib, pinned to distroless or Alpine base images with non-root users. Images are published to GCP Artifact Registry with SBOM metadata and vulnerability scanning enabled.
- **GCP Deployment**: The service runs on Cloud Run (regional) configured to stay within the Always Free tier (≤ 1 vCPU, ≤ 256 MiB memory, 2M requests/month). Set max concurrency ≤ 20, request timeout ≤ 60s, and CPU allocation `on-demand` to honor the cost envelope. Use Cloud Secret Manager for API keys and Cloud Logging/Monitoring for runtime telemetry. Persistent state must not rely on writable container filesystem; use GCP managed services instead.
- **Swagger UI Exposure**: Host Swagger UI via Springdoc at `/swagger-ui` (or equivalent) for every environment. Production/staging endpoints must sit behind identity-aware proxy or Basic Auth with per-user audit logging, and the published OpenAPI doc must match the deployed version. Disable Try-It-Out in production unless routed through a dedicated QA service account.
- **API Key Access Control**: All inbound traffic MUST present a 32+ byte API key in the `X-SmartLetter-Api-Key` header. Keys are generated by the platform team, stored only in Cloud Secret Manager, rotated at least every 90 days, and scoped per environment. Authentication middleware must enforce constant-time comparison, per-key rate limits, and structured audit logs. Swagger UI Try-It-Out may send the API key via the same header once the user enters it through a secure input control—no keys baked into the frontend.

## Workflow & Quality Gates

- **Definition of Ready**: A feature cannot enter implementation until the OpenAPI delta, prompt contract, and email template outline are documented, along with acceptance tests for success/failure paths.
- **Testing Expectations**: Unit tests back every controller/service; contract tests stub the LLM client; snapshot/integration tests render HTML + plaintext outputs; at least one automated scenario exercises the full request → LLM → email pipeline using recorded fixtures.
- **Container Readiness**: Before coding begins, teams must document container resource budgets, Cloud Run service settings (region, concurrency, memory), and how the change preserves Always Free limits. Every feature plan must include build/push automation steps.
- **Swagger Availability**: Definition of Ready also requires confirming the Swagger UI route, auth mechanism, and sample credentials for QA; all new/changed endpoints must be manually exercised through Swagger before code review completes.
- **INVEST User Stories**: Every feature spec and plan must decompose work into INVEST-compliant stories (Independent, Negotiable, Valuable, Estimable, Small, Testable). Stories must articulate measurable acceptance criteria and can be shipped incrementally without blocking others.
- **Incremental Delivery Cadence**: Work proceeds in short iterations. Each iteration targets the smallest shippable story, updates docs/tasks to reflect status, and must be demonstrable through Swagger or automated tests. Backlog stories stay prioritized; WIP limits prevent more than two simultaneous stories per engineer.
- **Code Review Checklist**: PRs must cite which principle they satisfy, attach contract diffs, and show evidence that fallbacks, validation, accessibility checks, containerization/GCP deployment updates, and API key handling are covered. No merge if any checklist item is unresolved.
- **Release Gate**: A release candidate must pass container image scans, complete a successful `gcloud run deploy` dry-run with Always Free settings, demonstrate zero critical alerts in staging for 24 hours, produce a sample outbound email approved by product/UX, and expose the matching Swagger UI with the latest OpenAPI schema accessible to QA via API key authentication.

## Governance

This constitution supersedes other development practices for the Smart Letter service. Amendments require an RFC describing the motivation, risk assessment, and migration plan, plus approval from the service tech lead and product owner. Version changes follow semantic rules: MAJOR for removals or redefinitions of principles/sections, MINOR for new principles or expanded guardrails, PATCH for clarifications that do not change obligations. Every merged feature plan/spec/tasks document must include a "Constitution Check" section that records compliance evidence. The release engineer schedules quarterly compliance reviews; any violations must be remediated before the next release or explicitly waived with documented risk acceptance.

**Version**: 1.4.0 | **Ratified**: 2025-11-22 | **Last Amended**: 2025-11-23
